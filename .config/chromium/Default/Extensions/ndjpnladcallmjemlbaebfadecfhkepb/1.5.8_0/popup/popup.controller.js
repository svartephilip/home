!function(){"use strict";angular.module("app.popup",[]).controller("PopupController",["$timeout","$scope","$q","$log","$document","constants","storage","userService","localize","notification",function(o,i,e,s,n,t,r,l,c,a){var u=this;function d(){s.debug("PopupController.refreshSignInStatus(): Method start"),u.userService.getUserType().then(function(e){s.debug(String.format("PopupController.getSignInStatus(): hasSignedIn: {0}",e)),s.trackEvent("PopupSignedIn_"+e),i.userType=e,u.hasSignedIn=e===u.constants.USER_TYPE.NONE?u.constants.SIGNINSTATUS.NONE:u.constants.SIGNINSTATUS.SIGNEDIN,u.hasSignedIn===u.constants.SIGNINSTATUS.SIGNEDIN&&(u.userService.waitForUserInfo(e).then(function(e){Utilities.isUndefinedOrNull(e)?s.warn("self.UserService.getUserInfo(): userInfo is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):Utilities.isUndefinedOrNull(e.email)?s.warn("self.UserService.getUserInfo(): userInfo.email is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):u.username=e.email}),l.getUserPhoto().then(function(e){u.profilePicture=e},function(e){u.profilePicture="",s.info(String.format("PopupController.getUserPhoto: Profile Picture Error - {0}",e))}))})}function I(){s.trackEvent("PopupSignOutLinkClick"),u.userService.logout(i.userType),u.hasSignedIn=u.constants.SIGNINSTATUS.NONE,i.userType=u.constants.USER_TYPE.NONE,r.remove("localRecentDocuments")}function p(){s.trackEvent("PopupOpenDocument_"+i.userType),u.userService.getUserInfo(i.userType,function(e){Utilities.isUndefinedOrNull(e)?s.warn("PopupController.openDocument(): invalid userInfo"):Utilities.isUndefinedOrNull(e.serviceInfo)||Utilities.isUndefinedOrNull(e.serviceInfo.resource)?s.warn("PopupController.openDocument(): invalid serviceInfo"):Utilities.navigateToUrlWithNewTab(e.serviceInfo.resource,!0)})}function N(){return i.userType===u.constants.USER_TYPE.O365}u.accountPanelOpened=!1,u.filesSelected=null,u.webRedirectInputChecked=!1,u.telemetryInputChecked=!1,u.onLine=!0,u.username="",u.profilePicture="",u.rtl=Utilities.isRTL(),u.isChrome=Utilities.isChrome(),u.onMenuItemClick=function(e){u.currentViewMode=u.currentViewMode===e?u.constants.MENU_VIEWMODE.NONE:u.currentViewMode=e},u.onSignOutClick=function(){u.currentViewMode=u.constants.MENU_VIEWMODE.NONE,u.hasSignedIn===u.constants.SIGNINSTATUS.SIGNEDIN&&I()},u.onWelcomeSignInClick=function(e){s.trackEvent("PopupSignInLinkClick"),BrowserHandler.runtime.sendMessage({activity:u.constants.ACTIVITY.AUTHENTICATION.NAME,type:e}),window.close()},u.onProfileClick=function(){u.accountPanelOpened=!u.accountPanelOpened},u.onSignOutLinkClick=I,u.onSignupLinkClick=function(){s.trackEvent("PopupSignupLinkClick"),Utilities.navigateToUrlWithNewTab(u.constants.LINKS.SIGNUP,!0)},u.onWebRedirectInputChange=function(){u.webRedirectInputChecked=!u.webRedirectInputChecked,u.storage.set({webRedirect_disabled:!u.webRedirectInputChecked}),s.trackEvent("PopupWebRedirectChecked",{enabled:u.webRedirectInputChecked})},u.onTelemetryInputChange=function(){u.telemetryInputChecked=!u.telemetryInputChecked,s.setEnabledSetting(u.telemetryInputChecked),s.trackEvent("PopupTelemetryInputChecked",{enabled:u.telemetryInputChecked})},u.onFileInputChange=function(){u.loadFile(),s.trackEvent("PopupFileInputChange")},u.onFeedbackClick=function(){Utilities.navigateToUrlWithNewTab(BrowserHandler.extension.getURL(u.constants.LINKS.FEEDBACK_URL),!0)},u.openDocument=p,u.openOfficeHome=function(){Utilities.navigateToUrlWithNewTab(u.constants.LINKS.OFFICE_HOME_URL,!0)},u.openSupportPage=function(){Utilities.navigateToUrlWithNewTab(u.constants.LINKS.SUPPORT_URL,!0)},u.openMyAccountPage=function(){var e=N()?u.constants.LINKS.MYACCOUNT_O365_URL:u.constants.LINKS.MYACCOUNT_MSA_URL;Utilities.navigateToUrlWithNewTab(e,!0)},u.browseToRecents=function(){s.trackEvent("PopupBrowseToRecents_"+i.userType),u.userService.getUserInfo(i.userType,function(e){Utilities.isUndefinedOrNull(e)?s.warn("PopupController.browseToRecents(): invalid userInfo"):Utilities.isUndefinedOrNull(e.serviceInfo)||Utilities.isUndefinedOrNull(e.serviceInfo.resource)?s.warn("PopupController.browseToRecents(): invalid serviceInfo"):Utilities.navigateToUrlWithNewTab(String.format("{0}{1}",e.serviceInfo.resource,N()?"":"/?qt=mru"),!0)})},u.createDocument=function(e,n){var t;{if(s.trackEvent("PopupCreateDocument_"+e.id),"OneDrive"===e.id)return void p();if("Outlook"===e.id)t=N()?u.constants.LINKS.APP.OUTLOOK_O365:u.constants.LINKS.APP.OUTLOOK_DEFAULT;else{if("SharePoint"===e.id)return void u.userService.getUserInfo(i.userType,function(e){Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(e.sharePointUrl)?Utilities.navigateToUrlWithNewTab(e.sharePointUrl,!0):(s.warn("PopupController.openDocument(): invalid sharePointUrl"),Utilities.navigateToUrlWithNewTab(u.constants.LINKS.APP.SHAREPOINT_DEFAULT,!0))});t=String.format(e.url,u.hasSignedIn!==u.constants.SIGNINSTATUS.SIGNEDIN?"0":N()?"2":"1")}}Utilities.navigateToUrlWithNewTab(t,!(!Utilities.isUndefinedOrNull(n)&&!Utilities.isUndefinedOrNull(n.ctrlKey))||!n.ctrlKey)},u.loadFile=function(){s.trackEvent("PopupLoadFile",{filesSelectedCount:u.filesSelected.length}),1<u.filesSelected.length&&s.warn(String.format("loadFile called with {0} files selected",u.filesSelected.length));if(!u.constants.FILE.SUPPORTED_FILE_TYPES[Utilities.getFileExtension(u.filesSelected[0].name)])return s.info(String.format("PopupController.loadFile(): User attempted to open an unsupported file type of {0} extension",Utilities.getFileExtension(u.filesSelected[0].name))),void a.show(u.constants.NOTIFICATION.UNSUPPORTEDFILETYPE);e=u.filesSelected[0],BrowserHandler.extension.getBackgroundPage().postMessage(e,window.location);var e},u.constants=t,u.storage=r,u.userService=l,u.localize=c,u.hasSignedIn=u.constants.SIGNINSTATUS.UNKNOWN,u.currentViewMode=u.constants.MENU_VIEWMODE.NONE,i.userType=u.constants.USER_TYPE.NONE,u.menuItems=[{id:"NewDocument",label:"CreateNewLabel",iconClass:"o365-Icon--circlePlus",viewMode:u.constants.MENU_VIEWMODE.NEW},{id:"OpenDocument",label:"OpenDocumentLabel",iconClass:"o365-Icon--folderOpen",viewMode:u.constants.MENU_VIEWMODE.OPEN},{id:"AccountInfo",label:"AccountLabel",iconClass:"o365-Icon--person2",viewMode:u.constants.MENU_VIEWMODE.ACCOUNT},{id:"Settings",label:"SettingsLabel",iconClass:"o365-Icon--gear",viewMode:u.constants.MENU_VIEWMODE.SETTINGS}],u.appLaunchers=[[{id:"Outlook",label:"OutlookAppName",iconClass:"ms-Icon ms-Icon--OutlookLogo ",colorClass:"outlook_color_fix",url:u.constants.LINKS.APP.OUTLOOK_DEFAULT,isBusinessOnly:!1},{id:"OneDrive",label:"OneDriveAppName",iconClass:"ms-Icon ms-Icon--OneDrive ",colorClass:"oneDrive_color_fix",url:u.constants.LINKS.APP.ONEDRIVE,isBusinessOnly:!1}],[{id:"WordOnline",label:"WordAppName",iconClass:"ms-Icon ms-Icon--WordLogo ",colorClass:"word_color_fix",url:u.constants.LINKS.APP.WORD,isBusinessOnly:!1},{id:"ExcelOnline",label:"ExcelAppName",iconClass:"ms-Icon ms-Icon--ExcelLogo ",colorClass:"excel_color_fix",url:u.constants.LINKS.APP.EXCEL,isBusinessOnly:!1}],[{id:"PowerPointOnline",label:"PowerPointAppName",iconClass:"ms-Icon ms-Icon--PowerPointLogo ",colorClass:"powerpoint_color_fix",url:u.constants.LINKS.APP.POWERPOINT,isBusinessOnly:!1},{id:"OneNoteOnline",label:"OneNoteAppName",iconClass:"ms-Icon ms-Icon--OneNoteLogo ",colorClass:"oneNote_color_fix",url:u.constants.LINKS.APP.ONENOTE,isBusinessOnly:!1}],[{id:"SharePoint",label:"SharePointSiteAppName",iconClass:"ms-Icon ms-Icon--SharepointLogo ",colorClass:"sharepoint_color_fix",url:u.constants.LINKS.APP.SHAREPOINT_DEFAULT,isBusinessOnly:!0},{id:"Teams",label:"TeamsAppName",iconClass:"ms-Icon ms-Icon--TeamsLogo ",colorClass:"teams_color_fix",url:u.constants.LINKS.APP.TEAMS,isBusinessOnly:!0}]],u.filePickers=[{id:u.constants.USER_TYPE.O365,label:"O365FilesLabel",fontClass:"o365-Icon--onedrive",isLocal:!1},{id:u.constants.USER_TYPE.MSA,label:"OneDriveFilesLabel",fontClass:"o365-Icon--onedrive",isLocal:!1},{id:"Local",label:"BrowseToOpenLabel",fontClass:"o365-Icon--desktop",isLocal:!0,isChrome:u.isChrome,isEdge:!1},{id:u.constants.USER_TYPE.O365,label:"UploadToOneDriveBusinessLabel",fontClass:"o365-Icon--desktop",isLocal:!0,isChrome:!1,isEdge:!u.isChrome},{id:u.constants.USER_TYPE.MSA,label:"UploadToOneDriveLabel",fontClass:"o365-Icon--desktop",isLocal:!0,isChrome:!1,isEdge:!u.isChrome}],n.ready(function(){o(function(){s.trackEvent("PopupPageLoad")});for(var e=document.querySelectorAll(".ms-Spinner"),n=0;n<e.length;n++)new fabric.Spinner(e[n]);for(var t=document.querySelectorAll(".ms-CheckBox"),n=0;n<t.length;n++)new fabric.CheckBox(t[n])}),this.getSignInInfo=function(n){s.debug("PopupController.getSignInInfo(): Method start"),u.storage.get("refreshToken").then(function(e){n(Utilities.isNotUndefinedOrNull(e.refreshToken)?u.constants.SIGNINSTATUS.HASSIGNININFO:u.constants.SIGNINSTATUS.NONE)})},u.getSignInInfo(function(e){u.hasSignedIn=e,u.hasSignedIn===u.constants.SIGNINSTATUS.HASSIGNININFO&&d()}),u.storage.get("webRedirect_disabled").then(function(e){u.webRedirectInputChecked=!(Utilities.isNotUndefinedOrNull(e.webRedirect_disabled)&&e.webRedirect_disabled)}),s.getEnabledSetting().then(function(e){s.setEnabledSetting(e),u.telemetryInputChecked=e})}]).directive("bindFileChange",function(){return{require:"ngModel",restrict:"A",link:function(e,n,t,o){n.bind("change",function(e){o.$setViewValue(e.target.files)})}}}).directive("bindDragAndDrop",["$log",function(i){return{require:"ngModel",restrict:"A",link:function(e,n,t,o){n.bind("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"}),n.bind("drop",function(e){e.stopPropagation(),e.preventDefault(),i.trackEvent("OpenDocument_Local_AppDragAndDrop"),o.$setViewValue(e.originalEvent.dataTransfer.files)})}}}]).directive("bindFileInputContainerClick",["constants","$log",function(t,o){return{restrict:"A",link:function(e,n){n.bind("mousedown keydown keypress",function(e){e.which!==t.JQUERY.EVENT_ID.MOUSEDOWN.LEFT_BUTTON_CLICK&&e.which!==t.JQUERY.EVENT_ID.KEYPRESS.ENTER||(o.trackEvent("OpenDocument_Local"),angular.element(e.currentTarget).children("#file_picker").trigger("click"),e.preventDefault())})}}}])}();