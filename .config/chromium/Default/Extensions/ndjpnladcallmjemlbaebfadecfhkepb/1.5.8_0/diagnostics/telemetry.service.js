!function(){"use strict";angular.module("app.diagnostics",[]).service("telemetry",["$injector","constants","ariaTelemetry",function(a,d,e){var s=[e],t=function(i){var e=a.get("$q"),n=a.get("userService"),r=e.defer();Utilities.isUndefinedOrNull(i)&&(i={}),i.pii=[];var t=Utilities.getManifest();t&&(i.appVersion=t.version);var s=BrowserHandler.i18n.getUILanguage();return Utilities.isNotUndefinedOrNull(s)&&(i.language=s),i["AppInfo.Name"]=d.APPINFO_NAME,n.getUserType().then(function(e){var t=AWTLogManager.getSemanticContext();if(e===d.USER_TYPE.NONE)return t.setUserId("","",""),void r.resolve(i);n.getUserInfo(e,function(e){if(Utilities.isUndefinedOrNull(e))return t.setUserId("","",""),void r.resolve(i);Utilities.isNotUndefinedOrNull(e.cid)&&(i.cid=e.cid,t.setUserId(e.cid),i["UserInfo.IdType"]=d.IDTYPE.MSACID),Utilities.isNotUndefinedOrNull(e.features)&&(i.experimentFeatures=e.features),Utilities.isNotUndefinedOrNull(e.puid)&&(i.pii.push({type:d.TELEMETRY.PII_TYPE.IDENTITY,name:"puid",value:e.puid}),t.setUserId(e.puid),i["UserInfo.IdType"]=d.IDTYPE.ORGIDPUID),Utilities.isNotUndefinedOrNull(e.tid)&&(i["UserInfo.OMSTenantId"]=e.tid),r.resolve(i)})}),r.promise};return{getEnabledSetting:function(){return e=a.get("$q"),t=a.get("storage"),i=e.defer(),t.get("telemetry_enabled").then(function(e){i.resolve(!(!Utilities.isUndefinedOrNull(e)&&!Utilities.isUndefinedOrNull(e.telemetry_enabled)&&!0!==e.telemetry_enabled))}),i.promise;var e,t,i},setEnabledSetting:function(e){if(Utilities.isBackgroundContext()){var t;t=e,a.get("storage").set({telemetry_enabled:t});for(var i=0;i<s.length;++i)s[i].setEnabledSetting(e)}else BrowserHandler.runtime.sendMessage({activity:d.ACTIVITY.TELEMETRY.NAME,command:d.TELEMETRY.COMMAND.SET_DISABLED,enabled:e})},trackEvent:function(n,e,r){!angular.isUndefined(n)&&angular.isString(n)&&(Utilities.isBackgroundContext()?t(e).then(function(e){for(var t=0;t<s.length;++t){var i=angular.extend({},e);s[t].trackEvent(n,i,r)}}):BrowserHandler.runtime.sendMessage({activity:d.ACTIVITY.TELEMETRY.NAME,command:d.TELEMETRY.COMMAND.TRACK_EVENT,eventName:n,properties:e,measurements:r}))},trackTrace:function(n,e){!angular.isUndefined(n)&&angular.isString(n)&&(Utilities.isBackgroundContext()?t(e).then(function(e){for(var t=0;t<s.length;++t){var i=angular.extend({},e);s[t].trackTrace(n,i)}}):BrowserHandler.runtime.sendMessage({activity:d.ACTIVITY.TELEMETRY.NAME,command:d.TELEMETRY.COMMAND.TRACK_TRACE,message:n,properties:e}))}}}])}();