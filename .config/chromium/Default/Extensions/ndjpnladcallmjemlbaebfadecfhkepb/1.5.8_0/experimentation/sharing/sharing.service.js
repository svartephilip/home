!function(){"use strict";angular.module("app.experimentation").factory("sharingService",["$http","$q","$log","constants","userService",function(l,o,u,a,f){return{setShareUrl:function(e,r){if(Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(e.url))return;if(e.shareUrl="",r===a.USER_TYPE.MSA){var i=e.url,n=i.replace("&page=view","&page=self");n.indexOf("&page=self")<0&&(n+="&page=self"),n+="&action=share",e.shareUrl=n}},setFlagFromPermissions:function(r,e){var i=o.defer();if(Utilities.isUndefinedOrNull(r))return i.resolve(),i.promise;if(e===a.USER_TYPE.MSA){return(t=r,s=o.defer(),(n=o.defer(),f.waitForUserInfo(a.USER_TYPE.MSA).then(function(e){if(Utilities.isUndefinedOrNull(e))return n.resolve(null),n.promise;n.resolve(e.cid)}),n.promise).then(function(i){if(Utilities.isUndefinedOrNull(i))return s.reject("null cid"),s.promise;if(Utilities.isUndefinedOrNull(t.id))return s.reject("no document id"),s.promise;var e=t.id.split("."),r=e[e.length-1],n={method:"GET",url:a.MSACONFIG.ONEDRIVE_ITEMS_URL+r+"/permissions",headers:{"X-UserType":a.USER_TYPE.MSA}};l(n).success(function(e){var r=function(e,r){if(Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(e.value))return!0;for(var i=!0,n=r.substring(1,r.length),t=0;t<e.value.length;++t){var s=e.value[t];if(!Utilities.isUndefinedOrNull(s.grantedTo)){var l=s.grantedTo.user;if(l.id===r||l.id===n){var o=s.roles;i=-1<o.toString().toLowerCase().indexOf("write")}}}return i}(e,i);s.resolve(r)}).error(function(e){s.reject(e)})}),s.promise).then(function(e){r.canBeShared=e,i.resolve()},function(e){u.error(String.format("sharingService.setFlagFromPermissions error: {0}",e)),r.canBeShared=!1,i.resolve()}),i.promise}var t,s,n;return r.canBeShared=!1,i.resolve(),i.promise}}}])}();