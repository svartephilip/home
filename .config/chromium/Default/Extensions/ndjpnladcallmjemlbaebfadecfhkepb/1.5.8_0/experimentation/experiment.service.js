!function(){"use strict";angular.module("app.experimentation").factory("experimentService",["$http","$q","$log","constants","experimentConstants","userService",function(o,s,f,l,u,E){var a,N=null,r=null,d={};d[l.USER_TYPE.MSA]="MSA",d[l.USER_TYPE.O365]="O365";var c={getFlight:function(r){var i=s.defer();return e(r).then(function(e){if(!e)return i.resolve(u.EXPERIMENTS[r].CONTROL),i.promise;n().then(function(e){i.resolve(e[r])})}),i.promise},getFlights:n,flightingDisabled:function(e){return t(e)},experimentEnabled:e};return c;function n(){var e=s.defer();return Utilities.isNotUndefinedOrNull(N)?e.resolve(N):Utilities.isNotUndefinedOrNull(r)?s.all([r]).then(function(){e.resolve(N)}):function(){var n=s.defer();r=n.promise;var t=function(e){return f.error(String.format("experimentService.setFlights error: {0}",e)),S(),n.resolve(),n.promise};return E.getUserType().then(function(i){return a=d[i],Utilities.isUndefinedOrNull(i)||i===l.USER_TYPE.NONE?t(u.ERROR.BAD_USER_TYPE):c.flightingDisabled(i)?(S(),n.resolve(),n.promise):void E.waitForUserInfo(i).then(function(r){if(Utilities.isNotUndefinedOrNull(r)&&Utilities.isNotUndefinedOrNull(r.flights))return N=r.flights,n.resolve(),n.promise;var e;(function(e){var r=s.defer();if(Utilities.isUndefinedOrNull(e)||e===u.DEFAULT_CLIENT_ID)return f.error("experimentService.getFeatures: clientId is undefined, null, or empty"),r.reject(u.ERROR.NO_CLIENT_ID),r.promise;var i,n=100<(i=function(e){var r,i,n="";for(i=0;i<e.length;i++)r=e.charCodeAt(i).toString(16),n+=("000"+r).slice(-4);return n}(e)).length?i.substring(0,100):i,t={method:"GET",url:u.ENDPOINT,headers:{"X-MSEDGE-CLIENTID":n}};return o(t).success(function(e){Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(e.Features)?r.resolve(e.Features):r.reject(u.ERROR.NO_FEATURES)}).error(function(e){r.reject(e)}),r.promise})((e=r,Utilities.isUndefinedOrNull(e)?u.DEFAULT_CLIENT_ID:Utilities.isNotUndefinedOrNull(e.cid)?e.cid:u.DEFAULT_CLIENT_ID)).then(function(e){!function(e){for(var r in N={},u.EXPERIMENTS)u.EXPERIMENTS.hasOwnProperty(r)&&v(e,r);!function(e){for(var r=[],i=0;i<e.length;++i){var n=e[i];p(n)&&r.push(n)}0<r.length&&f.error(String.format("ExP service returned invalid features: {0}",JSON.stringify(r)))}(e)}(e),r.flights=N,r.features=e,E.saveUserInfo(i,r),n.resolve()},t)},t)},t),n.promise}().then(function(){e.resolve(N)}),e.promise}function e(r){var i=s.defer();return E.getUserType().then(function(e){if(c.flightingDisabled(e))return i.resolve(!1),i.promise;i.resolve(!t(e,r))},function(e){return f.error(String.format("experimentService.experimentEnabled error: {0}",e)),i.resolve(!1),i.promise}),i.promise}function v(e,r){var i=u.EXPERIMENTS[r];if(N[r]=i.CONTROL,i.ENABLED[a])for(var n in i.FLIGHTS)if(i.FLIGHTS.hasOwnProperty(n)&&-1<e.indexOf(n)){N[r]=i.FLIGHTS[n];break}}function S(){for(var e in N={},u.EXPERIMENTS)if(u.EXPERIMENTS.hasOwnProperty(e)){var r=u.EXPERIMENTS[e];N[e]=r.CONTROL}}function p(e){for(var r in u.EXPERIMENTS)if(u.EXPERIMENTS.hasOwnProperty(r)){var i=u.EXPERIMENTS[r];if(i.FLIGHTS.hasOwnProperty(e))return!1}return!0}function t(e,r){if(e===l.USER_TYPE.NONE)return!0;var i=u.EXPERIMENTS.hasOwnProperty(r)?u.EXPERIMENTS[r].ENABLED:u.ENABLED,n=r||"all experiments",t=Utilities.getBrowserName().toLowerCase(),o=i.BROWSERS.toString().toLowerCase();if(o.indexOf(t)<0)return f.info(String.format("experimentService: experiment {0} is disabled for browser {1}. Experiment is only enabled for browsers {2}",n,t,o)),!0;var s=i[d[e]];return s||f.info(String.format("experimentService: experiment {0} is disabled for userType {1}",n,e)),!s}}])}();