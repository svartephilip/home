!function(){"use strict";angular.module("app.background",[]).controller("BackgroundController",["$window","$http","$q","$log","constants","notification","storage","userService","fileService","copyPasteService",function(e,t,r,s,n,o,a,l,i,d){var c,u,f;function S(t){var i=new Date;u?O(t,!1,i):a.get("LastSession").then(function(e){u=e&&e.LastSession&&e.LastSession.duration&&e.LastSession.startTime&&!Number.isNaN(Date.parse(e.LastSession.startTime))?e.LastSession:{startTime:new Date(i),duration:0},O(t,!0,i)})}function O(e,t,i){u.hasOwnProperty("start_time")&&(u.startTime=u.start_time,delete u.start_time);var r=new Date(u.startTime),n=new Date(i);(e||n.setHours(0,0,0,0)!==r.setHours(0,0,0,0))&&(s.trackEvent("Session",u),u.duration=0),t&&(u.startTime=new Date(i)),u.duration+=Date.parse(i)-Date.parse(u.startTime),u.startTime=i.toString(),a.set({LastSession:u})}a.get("refreshToken").then(function(e){Utilities.isNotUndefinedOrNull(e.refreshToken)?Utilities.setIcon(n.BROWSER_ICON.DEFAULT):Utilities.setIcon(n.BROWSER_ICON.INACTIVE)}),a.get("webRedirect_disabled").then(function(e){c=Utilities.isNotUndefinedOrNull(e.webRedirect_disabled)&&e.webRedirect_disabled}),BrowserHandler.windows.onFocusChanged.addListener(function(e){S()}),BrowserHandler.storage.onChanged.addListener(function(e,t){if(Utilities.isNotUndefinedOrNull(e.webRedirect_disabled))c=e.webRedirect_disabled.newValue;else if(Utilities.isNotUndefinedOrNull(e.refreshToken)){var i=e.refreshToken.newValue;Utilities.isNotUndefinedOrNull(i)?Utilities.setIcon(n.BROWSER_ICON.DEFAULT):Utilities.setIcon(n.BROWSER_ICON.INACTIVE)}}),BrowserHandler.webRequest.onSendHeaders.addListener(function(e){if("main_frame"===e.type)for(var t=0;t<e.requestHeaders.length;++t)if("Referer"===e.requestHeaders[t].name)return void(f=0<=e.requestHeaders[t].value.indexOf("officeapps.live.com")?null:e.tabId)},{urls:["*://*/*.doc","*://*/*.doct","*://*/*.docx","*://*/*.dotx","*://*/*.odt","*://*/*.ppt","*://*/*.pot","*://*/*.pps","*://*/*.pptx","*://*/*.ppsx","*://*/*.odp","*://*/*.xls","*://*/*.xlsx","*://*/*.xlsm","*://*/*.xlsb","*://*/*.ods"]},["requestHeaders"]),BrowserHandler.webRequest.onHeadersReceived.addListener(function(e){if(!c&&"main_frame"===e.type&&!(Utilities.isUndefinedOrNull(e.responseHeaders)||Utilities.isUndefinedOrNull(f)||Utilities.isUndefinedOrNull(e.tabId)||f!==e.tabId)){for(var t={},i=0;i<e.responseHeaders.length;++i)t[e.responseHeaders[i].name]=e.responseHeaders[i].value;if(!N(t,"Cache-Control")&&!N(t,"Pragma"))return t["Content-Type"]?n.FILE.OFFICE_MIME_TYPES[t["Content-Type"].toLowerCase()]?(s.trackEvent("OpenDocument_BrowserWebDocument"),a.get("displayWebDocRedirectNotification").then(function(e){(Utilities.isUndefinedOrNull(e.displayWebDocRedirectNotification)||!0===e.displayWebDocRedirectNotification)&&o.show(n.NOTIFICATION.WEBDOCREDIRECT)}),{redirectUrl:"https://view.officeapps.live.com/op/view.aspx?src="+e.url}):void s.warn(String.format("onHeadersReceived called with Content-Type {0}",t["Content-Type"])):void 0}},{urls:["*://*/*.doc","*://*/*.doct","*://*/*.docx","*://*/*.dotx","*://*/*.odt","*://*/*.ppt","*://*/*.pot","*://*/*.pps","*://*/*.pptx","*://*/*.ppsx","*://*/*.odp","*://*/*.xls","*://*/*.xlsx","*://*/*.xlsm","*://*/*.xlsb","*://*/*.ods"]},["responseHeaders","blocking"]),BrowserHandler.webRequest.onBeforeRequest.addListener(function(e){if("main_frame"===e.type){s.trackEvent("OpenDocument_BrowserDragAndDrop");var t=e.tabId;return i.upload(e.url,n.FILE.ORIGIN.LOCAL_PATH,function(e){Utilities.isUndefinedOrNull(e)||p(e,t)}),{redirectUrl:n.LINKS.PROGRESSPAGE_URL}}},{urls:["file:///*.doc","file:///*.doct","file:///*.docx","file:///*.dotx","file:///*.odt","file:///*.ppt","file:///*.pot","file:///*.pps","file:///*.pptx","file:///*.ppsx","file:///*.odp","file:///*.xlsx","file:///*.xlsm","file:///*.xlsb","file:///*.ods"]},["blocking"]),BrowserHandler.webRequest.onErrorOccurred.addListener(function(e){s.error(String.format("BackgroundWebRequestOnErrorOccured - {0}",e.error))},{urls:["file:///*.doc","file:///*.doct","file:///*.docx","file:///*.dotx","file:///*.odt","file:///*.ppt","file:///*.pot","file:///*.pps","file:///*.pptx","file:///*.ppsx","file:///*.odp","file:///*.xlsx","file:///*.xlsm","file:///*.xlsb","file:///*.ods"]}),BrowserHandler.runtime.onInstalled.addListener(function(e){var t=Utilities.getManifest(),i=t?t.version:-1;"install"===e.reason?(s.trackEvent(String.format("AppInstalled_{0}",i)),o.show(n.NOTIFICATION.FILEACCESS),p(n.LINKS.SUPPORT_URL,null),BrowserHandler.runtime.getPlatformInfo(function(e){"cros"===e.os&&o.show(n.NOTIFICATION.SETDEFAULT)})):"update"===e.reason&&(s.trackEvent(String.format("AppUpdated_{0}",i),{previousVersion:e.previousVersion}),Utilities.isNotUndefinedOrNull(window.localStorage.getItem(n.OAUTH.SERVICE_ID))&&(a.clear(),window.localStorage.clear()),a.get("userInfo").then(function(e){Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(e.userInfo)&&(Utilities.isNotUndefinedOrNull(e.userInfo.id)||Utilities.isNotUndefinedOrNull(e.userInfo.profile))&&(a.clear(),window.localStorage.clear())}))}),BrowserHandler.notifications.onButtonClicked.addListener(function(e){switch(e){case n.NOTIFICATION.AUTOSAVE.id:a.set({displayAutoSaveNotification:!1});break;case n.NOTIFICATION.WEBDOCREDIRECT.id:a.set({displayWebDocRedirectNotification:!1})}}),BrowserHandler.notifications.onClicked.addListener(function(e){switch(e){case n.NOTIFICATION.FILEACCESS.id:BrowserHandler.tabs.create({url:n.LINKS.SETTINGS_URL});break;case n.NOTIFICATION.INVALIDSUBSCRIPTION.id:BrowserHandler.tabs.create({url:n.LINKS.OFFICE_URL})}}),BrowserHandler.runtime.onMessage.addListener(function(r,e,t){switch(s.debug(String.format("BackgroundController.onMessage: Processing request activity {0}",r.activity)),r.activity){case n.ACTIVITY.SSO.NAME:try{r.body.sender=e.url,BrowserHandler.runtime.sendNativeMessage(n.SSO.MESSAGE_CHANNEL,r.body,function(e){Utilities.isNotUndefinedOrNull(e)?e.status&&e.status===n.SSO.RESPONSE_STATUS_FAIL&&e.code?(s.trackEvent("SSO_FAIL",{status:n.SSO.RESPONSE_STATUS_FAIL,code:e.code,description:BrowserHandler.runtime.lastError.message}),t(e)):(s.trackEvent("SSO_SUCCESS"),t({status:n.SSO.RESPONSE_STATUS_SUCCESS,result:e})):(s.trackEvent("SSO_FAIL",{status:n.SSO.RESPONSE_STATUS_FAIL,code:n.SSO.RESPONSE_CODE_NO_SUPPORT,description:BrowserHandler.runtime.lastError.message}),t({status:n.SSO.RESPONSE_STATUS_FAIL,code:n.SSO.RESPONSE_CODE_NO_SUPPORT,description:BrowserHandler.runtime.lastError.message}))})}catch(e){s.trackEvent("SSO_FAIL",{status:n.SSO.RESPONSE_STATUS_FAIL,code:n.SSO.RESPONSE_CODE_NO_SUPPORT,description:e.toString()}),t({status:n.SSO.RESPONSE_STATUS_FAIL,code:n.SSO.RESPONSE_CODE_NO_SUPPORT,description:e.toString()})}return!0;case n.ACTIVITY.TELEMETRY.NAME:switch(r.command){case n.TELEMETRY.COMMAND.SET_DISABLED:s.setEnabledSetting(r.enabled),I(r.enabled);break;case n.TELEMETRY.COMMAND.TRACK_EVENT:s.trackEvent(r.eventName,r.properties,r.measurements);break;case n.TELEMETRY.COMMAND.TRACK_TRACE:s.trackTrace(r.message,r.properties)}break;case n.ACTIVITY.NOTIFICATION.NAME:o.show(r.notification);break;case n.ACTIVITY.AUTHENTICATION.NAME:l.login(r.type);break;case n.ACTIVITY.AUTHORIZATION.NAME:BrowserHandler.tabs.query({active:!0,lastFocusedWindow:!0},function(e){if(Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(e[0]))s.error(String.format("BackgroundController.onMessage: Error processing request activity {0}; active tab undefined or null",r.activity));else{var i=e[0];a.get("loginTabId").then(function(e){if(Utilities.isUndefinedOrNull(e.loginTabId)||e.loginTabId!==i.id)s.error(String.format("BackgroundController.onMessage: Processing request activity {0}; loginTabId undefined or null or different from storage",r.activity));else{a.remove("loginTabId"),BrowserHandler.tabs.remove(i.id);var t=Utilities.deserializeQuery(r.query);t.hasOwnProperty(n.OAUTH.CODE)&&l.authenticate(r.type,t.code)}})}})}}),Utilities.isChrome()&&(BrowserHandler.runtime.onMessageExternal.addListener(function(e,t,i){switch(e.command){case n.COPY_PASTE.TEST:return d.handleTestCommand(e,t,i);case n.COPY_PASTE.COPY:return d.handleCopyCommand(e,t,i);case n.COPY_PASTE.PASTE:return d.handlePasteCommand(e,t,i);default:return!1}}),e.addEventListener("paste",d.onPasteEvent));function E(e,t){Utilities.isUndefinedOrNull(e)?t(null):i.upload(e,n.FILE.ORIGIN.HTML5,function(e){t(e)})}function p(t,e){var i=r.defer();i.resolve(Utilities.isNotUndefinedOrNull(e)?e:function(t){Utilities.isUndefinedOrNull(t)&&(t=n.LINKS.PROGRESSPAGE_URL);var i=r.defer();return BrowserHandler.windows.getAll(function(e){0===e.length?BrowserHandler.windows.create({url:t,type:"normal"},function(e){i.resolve(e.tabs[0].id)}):BrowserHandler.tabs.create({url:t},function(e){i.resolve(e.id)})}),i.promise}(t)),i.promise.then(function(e){Utilities.isUndefinedOrNull(e)?s.warn(String.format("BackgroundController.openFileUrlInTab(): tabIdPromise null or undefined")):BrowserHandler.tabs.update(e,{url:t})})}function N(e,t){return e[t]&&-1!==e[t].toLowerCase().indexOf("private")}function I(e){if(Utilities.isNotUndefinedOrNull(e)||(e=!0),Utilities.isNotUndefinedOrNull(BrowserHandler.runtime.setUninstallURL)){var t=Utilities.getManifest(),i=t?t.version:-1,r=Utilities.isExtensionInDevelopmentMode()?n.LINKS.OFFICE_HOME_DEV_URL:n.LINKS.OFFICE_HOME_URL;e&&(r=n.LINKS.UNINSTALL+"?version="+i,r=Utilities.isExtensionInDevelopmentMode()?r+"&isDebug=true":r),BrowserHandler.runtime.setUninstallURL(r)}}BrowserHandler.tabs.onReplaced.addListener(function(e,t){a.set({loginTabId:e})}),BrowserHandler.runtime.getPlatformInfo(function(e){"cros"===e.os&&BrowserHandler.fileBrowserHandler.onExecute.addListener(function(e,t){var i=t.entries;!function(e,t){if(Utilities.isUndefinedOrNull(e))return t(null);for(var i=0;i<e.length;++i)e[i].file(function(e){E(e,function(e){t(e)})})}(i,function(e){Utilities.isUndefinedOrNull(e)||p(e,null)})})}),window.addEventListener("message",function(e){if(0!==BrowserHandler.runtime.getURL("").search(new RegExp(e.origin,"i")))return void s.error(String.format("BackgroundController.receiveMessage: Error processing message with unrecognized origin {0}",e.origin));if("[object File]"!==Object.prototype.toString.call(e.data))return void s.error(String.format("BackgroundController.receiveMessage: Error processing message with event.data type {0}",Object.prototype.toString.call(e.data)));E(e.data,function(e){Utilities.isUndefinedOrNull(e)||p(e,null)})},!1),S(),s.getEnabledSetting().then(function(e){I(e)})}])}();