!function(){"use strict";angular.module("app.mru").controller("MruController",["$scope","$q","$log","constants","storage","mruService",function(e,n,o,t,i,r){var c=this;c.onLoad=function(){o.debug("Loading MruController"),c.currentDisplayPanel=c.constants.RECENTS.DISPLAY_PANEL.LOADING,c.getRecentDocumentsFromStorage().then(function(e){!Utilities.isUndefinedOrNull(e)&&0<e.length&&(c.recentDocuments=e,c.currentDisplayPanel=c.constants.RECENTS.DISPLAY_PANEL.LIST)})},c.openRecentDocument=function(e,t){o.trackEvent("PopupOpenRecentDocument_"+e.application),Utilities.navigateToUrlWithNewTab(e.url,!(!Utilities.isUndefinedOrNull(t)&&!Utilities.isUndefinedOrNull(t.ctrlKey))||!t.ctrlKey),window.close()},c.constants=t,c.storage=i,c.currentDisplayPanel=c.constants.RECENTS.DISPLAY_PANEL.LOADING,c.recentDocuments=[],c.LIST_LENGTH=c.constants.RECENTS.LIST_LENGTH_MSA,e.$watch("userType",function(e){e!==c.constants.USER_TYPE.NONE&&(c.LIST_LENGTH=e===c.constants.USER_TYPE.O365?c.constants.RECENTS.LIST_LENGTH_O365:c.constants.RECENTS.LIST_LENGTH_MSA,c.refreshRecentDocumentsList().then(function(){c.currentDisplayPanel=!Utilities.isUndefinedOrNull(c.recentDocuments)&&0<c.recentDocuments.length?c.constants.RECENTS.DISPLAY_PANEL.LIST:c.constants.RECENTS.DISPLAY_PANEL.NO_DOCS},function(e){o.debug(String.format("MruController $scope.$watch error on refreshRecentDocumentsList: {0}",e)),c.currentDisplayPanel=!Utilities.isUndefinedOrNull(c.recentDocuments)&&0<c.recentDocuments.length?c.constants.RECENTS.DISPLAY_PANEL.LIST:c.constants.RECENTS.DISPLAY_PANEL.ERROR}))}),this.refreshRecentDocumentsList=function(){var s=n.defer();return o.debug("MruController.refreshRecentDocumentsList(): Method start"),r.getRecentDocumentList().then(function(e){Utilities.isUndefinedOrNull(e)&&(e=[]);for(var t=[],n=0,i=0;i<e.length&&n<c.LIST_LENGTH;i++)Utilities.isUndefinedOrNull(e[i].Application)?o.warn(String.format("Undefined document application with document type {0}",Utilities.getFileExtension(e[i].FileName))):c.isFileDataValid(e[i].FileName,e[i].Application,e[i].DocumentUrl,e[i].Timestamp)&&(t.push({appLabel:c.constants.FILE.APPLICATION_LABEL[e[i].Application.toLowerCase()],application:e[i].Application,lastAccessed:new Date(e[i].Timestamp).toLocaleDateString(),imageSource:"../"+c.constants.FILE.APPLICATION_IMAGE_PATH[e[i].Application.toLowerCase()],name:c.shortenFilename(e[i].FileName),url:c.createOpenInWebUrl(e[i].DocumentUrl),id:e[i].Id}),n++);c.mruListsEqual(c.recentDocuments,t)||(c.recentDocuments=t,c.setRecentDocumentsToStorage(t)),s.resolve()},function(e){s.reject(e)}),s.promise},this.mruListsEqual=function(e,t){if(Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(t)||e.length!==t.length)return!1;for(var n=0;n<t.length;n++)if(t[n].name!==e[n].name||t[n].url!==e[n].url||t[n].lastAccessed!==e[n].lastAccessed)return!1;return!0},this.getRecentDocumentsFromStorage=function(){var t=n.defer();return i.get("localRecentDocuments").then(function(e){t.resolve(e.localRecentDocuments)}),t.promise},this.setRecentDocumentsToStorage=function(e){i.set({localRecentDocuments:e})},this.isFileDataValid=function(e,t,n,i){return!(Utilities.isUndefinedOrNull(t)||!c.constants.FILE.APPLICATION_LABEL[t.toLowerCase()])&&(Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(n)&&Utilities.isNotUndefinedOrNull(i))},this.createOpenInWebUrl=function(e){return c.constants.FILE.SUPPORTED_FILE_TYPES[Utilities.getFileExtension(e)]?e+"?web=1":e},this.shortenFilename=function(e){var t=e.replace(/\.[^/.]+$/,"");return t}}])}();