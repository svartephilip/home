!function(){"use strict";angular.module("app.user",[]).factory("userService",["$q","$log","$injector","constants","storage","notification","msaUserService","o365UserService",function(s,l,f,c,a,n,t,i){function o(e,r,t,n){3===arguments.length&&"[object Function]"===Object.prototype.toString.call(t)?(n=t,t=null):2===arguments.length&&"[object Function]"===Object.prototype.toString.call(r)&&(n=r,r=null);var i=U(e);if(Utilities.isUndefinedOrNull(i))return l.error("userService.acquireToken - Invalid type"),void n(null);var o,s,u=i.getConfig();u.params.grant_type=c.OAUTH.REFRESH_TOKEN,4!==arguments.length&&3!==arguments.length||i.type!==c.USER_TYPE.O365||(Utilities.isUndefinedOrNull(t)?u.resource=i.getResourceForEndpoint(r):u.resource=t,u.params.resource=u.resource),o=u.resource,s=function(e){var r,t;Utilities.isNotUndefinedOrNull(e)?n(e):(r=i.type,t=function(e){if(Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(e))n(null);else{u.params.refresh_token=e;var r=f.get("$http"),t={method:"POST",url:u.url,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},data:$.param(u.params)};r(t).success(function(e){T(u.resource,e),p(i.type,e),a.set({userType:i.type}),n(e.access_token)}).error(function(){d(),n(null)})}},a.get("refreshToken").then(function(e){Utilities.isUndefinedOrNull(e.refreshToken)||Utilities.isUndefinedOrNull(e.refreshToken[r])?t(null):t(e.refreshToken[r])}))},a.get("accessToken").then(function(e){var r,t;Utilities.isUndefinedOrNull(e.accessToken)||Utilities.isUndefinedOrNull(e.accessToken[o])?s(null):(r=e.accessToken[o].expires_on,t=Utilities.getCurrentTime(),s(r&&t+120<r?e.accessToken[o].access_token:null))})}function d(){a.remove("accessToken"),a.remove("refreshToken"),a.remove("userInfo"),a.remove("userType")}function e(r){a.get("userType").then(function(e){Utilities.isUndefinedOrNull(e.userType)?r(!1):o(e.userType,function(e){r(Utilities.isNotUndefinedOrNull(e))})})}function U(e){var r=null;switch(e){case c.USER_TYPE.MSA:r=t;break;case c.USER_TYPE.O365:r=i;break;default:l.error(String.format("userService.getUserServiceProvider - Invalid type - {0}",e))}return r}function p(r,t){a.get("refreshToken").then(function(e){Utilities.isUndefinedOrNull(e.refreshToken)&&(e.refreshToken={}),e.refreshToken[r]=t.refresh_token,a.set(e)})}function T(r,t){Utilities.isUndefinedOrNull(t.expires_on)&&(t.expires_on=Utilities.getCurrentTime()+t.expires_in),a.get("accessToken").then(function(e){Utilities.isUndefinedOrNull(e.accessToken)&&(e.accessToken={}),e.accessToken[r]=t,a.set(e)})}function u(r,t){a.get("userInfo").then(function(e){Utilities.isUndefinedOrNull(e.userInfo)||Utilities.isUndefinedOrNull(e.userInfo[r])?t(null):t(e.userInfo[r])})}function v(r,t){var n=s.defer();return a.get("userInfo").then(function(e){Utilities.isUndefinedOrNull(e.userInfo)&&(e.userInfo={}),e.userInfo[r]={},e.userInfo[r].email=t.email,e.userInfo[r].puid=t.puid,e.userInfo[r].tid=t.tid,e.userInfo[r].cid=t.cid,e.userInfo[r].serviceInfo=t.serviceInfo,e.userInfo[r].flights=t.flights,e.userInfo[r].features=t.features,e.userInfo[r].photo=t.photo,e.userInfo[r].sharePointUrl=t.sharePointUrl,a.set(e),n.resolve(e.userInfo[r])}),n.promise}function g(r,e){var t=U(r);t.lookupUserInfo(e,function(e){BrowserHandler.runtime.sendMessage({activity:c.ACTIVITY.USERINFO_AVAILABLE.NAME,data:e}),v(r,e),O(r,e)})}function O(t,e){var n=s.defer(),r=f.get("$http");if(t===c.USER_TYPE.O365&&(Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(e.email)))return n.reject(),n.promise;var i=t===c.USER_TYPE.MSA?c.MSACONFIG.PHOTO_URL:String.format(c.O365CONFIG.PHOTO_URL,e.email),o={method:"GET",url:i,responseType:"blob",headers:{"X-UserType":t}};return r(o).success(function(e){l.trackEvent(String.format("UserService_GotServerPhoto_{0}",t));var r=new FileReader;r.onload=function(){u(t,function(e){Utilities.isNotUndefinedOrNull(e)&&(e.photo=r.result,v(t,e))}),n.resolve(r.result)},r.readAsDataURL(e)}).error(function(e){n.reject(e)}),n.promise}var I={acquireToken:o,authenticate:function(e,r){var t=U(e);if(Utilities.isUndefinedOrNull(t))return void l.error("userService.authenticate - Invalid type");!function(r,e,t){var n=r.getConfig();if(Utilities.isUndefinedOrNull(r))return l.error("userService.acquireTokenFromCode - Invalid type"),t(null);n.params.grant_type=c.OAUTH.AUTH_CODE,n.params.code=e;var i=f.get("$http"),o={method:"POST",url:n.url,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},data:$.param(n.params)};i(o).success(function(e){T(n.resource,e),p(r.type,e),a.set({userType:r.type}),g(r.type,e),t(e.access_token)}).error(function(){t(null)})}(t,r,function(e){Utilities.isUndefinedOrNull(e)?t.type===c.USER_TYPE.O365&&n.show(c.NOTIFICATION.INVALIDSUBSCRIPTION):l.trackEvent(String.format("Authorization_Success_{0}",t.type))})},clearToken:d,getLoginStatus:e,getUserType:function(){var r=s.defer();return e(function(e){if(!e)return r.resolve(c.USER_TYPE.NONE),r.promise;a.get("userType").then(function(e){Utilities.isUndefinedOrNull(e.userType)?r.resolve(c.USER_TYPE.NONE):r.resolve(e.userType)})}),r.promise},getUserInfo:u,waitForUserInfo:function(i){var o=s.defer();return I.getUserInfo(i,function(e){if(Utilities.isNotUndefinedOrNull(e))return o.resolve(e),o.promise;BrowserHandler.runtime.onMessage.addListener(n);var r=Utilities.isExtensionInTestingMode()?c.TIMEOUT.USER_INFO_LOOKUP_TEST:c.TIMEOUT.USER_INFO_LOOKUP,t=setTimeout(function(){l.warn(String.format("userService.waitForUserInfo timed out after {0} ms - {1}",c.TIMEOUT.USER_INFO_LOOKUP,i)),BrowserHandler.runtime.onMessage.removeListener(n),o.resolve(e)},r);function n(e){e.activity===c.ACTIVITY.USERINFO_AVAILABLE.NAME&&(BrowserHandler.runtime.onMessage.removeListener(n),clearTimeout(t),o.resolve(e.data))}}),o.promise},saveUserInfo:v,login:function(e){var r=U(e);if(Utilities.isUndefinedOrNull(r))return void l.error("userService.login - Invalid type");BrowserHandler.tabs.create({url:r.getConfig().loginUrl},function(e){a.set({loginTabId:e.id})})},logout:function(e){d();var r=U(e);if(Utilities.isUndefinedOrNull(r))return void l.error("userService.logout - Invalid type");var t=f.get("$http"),n={method:"GET",url:r.getConfig().logoutUrl};t(n).success(function(){l.debug(String.format("userService.logout - {0}",e))})},getUserPhoto:function(){var t=s.defer();return I.getUserType().then(function(r){if(r===c.USER_TYPE.NONE)return l.warn("UserService.getUserPhoto: no signed-in user"),t.reject(c.RECENTS.ERROR.UNSUPPORTED_USER_TYPE),t.promise;I.getUserInfo(r,function(e){if(Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(e.photo))return l.trackEvent(String.format("UserService_GotLocalPhoto_{0}",r)),t.resolve(e.photo),t.promise;t.reject("No photo in local storage")})}),t.promise},getPhotoFromServer:O,lookupUserInfo:g};return I}])}();