!function(){"use strict";angular.module("app.user").service("o365UserService",["$log","$injector","constants","notification",function(u,l,s,a){function O(){var e=l.get("userService");e.clearToken()}function c(e){var r={},n=function(e){var r=function(e){var r=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(!r||r.length<4)return u.error("The returned id_token is not parseable."),null;return{header:r[1],JWSPayload:r[2],JWSSig:r[3]}}(e);if(!r)return null;try{var n=r.JWSPayload,t=function(e){if(e=e.replace(/-/g,"+").replace(/_/g,"/"),window.atob)return decodeURIComponent(escape(window.atob(e)));return null}(n);return t?JSON.parse(t):(this._logstatus("The returned id_token could not be base64 url safe decoded."),null)}catch(e){u.error("The returned id_token could not be decoded: "+e.stack)}return null}(e);return n&&n.hasOwnProperty("aud")&&(n.aud.toLowerCase()===s.O365CONFIG.CLIENT_ID.toLowerCase()?(n.hasOwnProperty("upn")?r.email=n.upn:n.hasOwnProperty("email")&&(r.email=n.email),n.hasOwnProperty("puid")&&(r.puid=n.puid),n.hasOwnProperty("tid")&&(r.tid=n.tid)):u.error("IdToken has invalid aud field")),r}this.type=s.USER_TYPE.O365,this.getConfig=function(){var e={url:s.O365CONFIG.INSTANCE+"token",params:{client_id:s.O365CONFIG.CLIENT_ID,client_secret:s.O365CONFIG.CLIENT_SECRET,redirect_uri:s.O365CONFIG.REDIRECT_URI,resource:s.O365CONFIG.DISCOVERY_RESOURCE},resource:s.O365CONFIG.DISCOVERY_RESOURCE,loginUrl:s.O365CONFIG.INSTANCE+"authorize?response_type=code&client_id="+s.O365CONFIG.CLIENT_ID+"&redirect_uri="+s.O365CONFIG.REDIRECT_URI,logoutUrl:s.O365CONFIG.LOGOUT_URI};return e},this.getResourceForEndpoint=function(e){var r=null;if(Utilities.isUndefinedOrNull(e))return r;for(var n in s.O365CONFIG.ENDPOINTS)s.O365CONFIG.ENDPOINTS.hasOwnProperty(n)&&-1<e.indexOf(n)&&(r=s.O365CONFIG.ENDPOINTS[n]);return r},this.lookupUserInfo=function(e,i){var t,r,n,o=c(e.id_token);t=function(e){var r,n,t;o.serviceInfo=e,r=function(e){o.sharePointUrl=Utilities.isUndefinedOrNull(e)?s.LINKS.APP.SHAREPOINT_DEFAULT:e,i(o)},n=l.get("$http"),t={method:"GET",url:s.O365CONFIG.SHAREPOINT_URL,headers:{"X-UserType":s.USER_TYPE.O365}},n(t).success(function(e){Utilities.isNotUndefinedOrNull(e.webUrl)?r(e.webUrl):r(null)}).error(function(){r(null)})},r=l.get("$http"),n={method:"GET",url:s.O365CONFIG.DISCOVERY_URL,headers:{"X-UserType":s.USER_TYPE.O365}},r(n).success(function(e){for(var r=0;r<e.value.length;++r)if("MyFiles"===e.value[r].capability&&"v2.0"===e.value[r].serviceApiVersion){var n={};return n.resource=e.value[r].serviceResourceId,n.url=e.value[r].serviceEndpointUri,void t(n)}O(),a.show(s.NOTIFICATION.INVALIDSUBSCRIPTION),u.info(String.format("o365UserService.DiscoverServiceEndpoint - Invalid resource")),t(null)}).error(function(){O(),a.show(s.NOTIFICATION.INVALIDSUBSCRIPTION),t(null)})}}])}();